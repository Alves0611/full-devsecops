name: Docker Build and Push

on:
  workflow_call:
    inputs:
      app-jar:
        required: true
        type: string
    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true

jobs:
  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.app-jar }}
          path: target/

      - name: Dockerhub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ secrets.DOCKER_USERNAME }}/devsecops:${{ github.sha }}
          load: true

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@v3
        with:
          image-ref: '${{ secrets.DOCKER_USERNAME }}/devsecops:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy image scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-image-scan-results
          path: trivy-image-results.sarif

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-image-results.sarif'

      - name: Push Docker image (only if scan passes)
        if: success()
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/devsecops:${{ github.sha }}

      - name: Comment Docker Security Results
        if: always()
        run: |
          echo "## ðŸ³ Docker Security Scanning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ›¡ï¸ Trivy Image Scan" >> $GITHUB_STEP_SUMMARY
          if [ -f "trivy-image-results.sarif" ]; then
            echo "âœ… **Status:** Completed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š **Format:** SARIF (uploaded to Security tab)" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” **Severity:** CRITICAL, HIGH" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Security Tab:** View detailed results in GitHub Security tab" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš¨ **Action:** Image not pushed due to security issues" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Docker Image" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **Status:** Built and pushed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ·ï¸ **Tag:** ${{ secrets.DOCKER_USERNAME }}/devsecops:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Build or push failed" >> $GITHUB_STEP_SUMMARY
          fi
